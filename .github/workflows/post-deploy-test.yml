name: Post-deploy API healthcheck

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  health-check:
    name: 🔍 Verificar se a API está online
    runs-on: ubuntu-latest
    steps:
      - name: Requisitar endpoint raiz /
        run: |
          curl -sSf https://assistente-co2.onrender.com/ | grep '"message"'

  comparar-teste:
    name: 📊 Testar endpoint /comparar
    runs-on: ubuntu-latest
    steps:
      - name: Enviar payload para /comparar
        run: |
          curl -X POST https://assistente-co2.onrender.com/comparar \
            -H "Content-Type: application/json" \
            -d '{"projetos": [{"programa_id": 1, "adicionalidade": true}, {"programa_id": 2, "adicionalidade": false}]}' \
            | grep '"programa_id"'

  avaliar-detalhado-teste:
    name: 🧪 Testar /avaliar_detalhado + GET /avaliacao/{id}
    runs-on: ubuntu-latest
    env:
      API_KEY: ${{ secrets.API_KEY }}
    steps:
      - name: Enviar dados para /avaliar_detalhado e salvar UUID
        id: avaliar
        run: |
          RESPONSE=$(curl -s -X POST https://assistente-co2.onrender.com/avaliar_detalhado \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $API_KEY" \
            -d '{"programa_id": 1, "adicionalidade": true}')
          echo "RESPONSE=$RESPONSE" >> $GITHUB_ENV
          UUID=$(echo $RESPONSE | grep -oP '"id"\s*:\s*"\K[^"]+')
          echo "UUID=$UUID" >> $GITHUB_ENV

      - name: Requisitar /avaliacao/{uuid} com UUID retornado
        run: |
          curl -s https://assistente-co2.onrender.com/avaliacao/$UUID \
            -H "Authorization: Bearer $API_KEY" \
            | grep '"pontuacao_total"'

      - name: Verificar integridade do score
        run: |
          SCORE=$(echo $RESPONSE | grep -oP '"pontuacao_total"\s*:\s*\K[0-9.]+')
          if (( $(echo "$SCORE < 0" | bc -l) )) || (( $(echo "$SCORE > 14" | bc -l) )); then
            echo "Score fora do intervalo esperado: $SCORE"
            exit 1
          fi

  relatorio-teste:
    name: 📄 Verificar /relatorio com ID inválido
    runs-on: ubuntu-latest
    env:
      API_KEY: ${{ secrets.API_KEY }}
    steps:
      - name: Tentar baixar PDF com UUID inexistente
        run: |
          curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $API_KEY" \
            https://assistente-co2.onrender.com/relatorio/uuid-invalido | grep 404
